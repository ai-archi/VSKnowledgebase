# SQLite + FTS5 + MCP Server çŸ¥è¯†åº“æœç´¢æ–¹æ¡ˆ

## ğŸ“‹ ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°

### 1.1 ç›®æ ‡

åœ¨ MCP Server ä¸­å®ç°åŸºäº SQLite FTS5 çš„è½»é‡çº§æœ¬åœ°çŸ¥è¯†åº“æœç´¢åŠŸèƒ½ï¼Œæä¾›ï¼š
- âœ… å¿«é€Ÿå…¨æ–‡æœç´¢ï¼ˆ<5ms å“åº”æ—¶é—´ï¼‰
- âœ… æ”¯æŒä¸­æ–‡æœç´¢ï¼ˆunicode61 tokenizerï¼‰
- âœ… è¿”å›æœ¬åœ°æ–‡ä»¶è·¯å¾„ï¼ˆä¾¿äº AI å·¥å…·å¼•ç”¨ï¼‰
- âœ… é«˜äº®ç‰‡æ®µè¿”å›ï¼ˆsnippet åŠŸèƒ½ï¼‰
- âœ… æ— éœ€å¤–éƒ¨æœåŠ¡ï¼ˆçº¯æœ¬åœ°å®ç°ï¼‰
- âœ… å®Œå…¨ç‹¬ç«‹è¿è¡Œï¼ˆä¸ä¾èµ– VS Code æ‰©å±•æˆ–ä»»ä½•æ’ä»¶ï¼‰

### 1.2 è®¾è®¡åŸåˆ™

1. **å®Œå…¨ç‹¬ç«‹æ€§**ï¼šMCP Server æ˜¯å®Œå…¨ç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä¸ä¾èµ– VS Code æ‰©å±•ã€æ’ä»¶æˆ–ä»»ä½•å¤–éƒ¨æœåŠ¡
2. **è½»é‡çº§**ï¼šä½¿ç”¨ SQLite FTS5ï¼Œæ— éœ€å‘é‡åº“æˆ–å¤–éƒ¨æœåŠ¡
3. **è‡ªåŒ…å«**ï¼šç›´æ¥è®¿é—®æ–‡ä»¶ç³»ç»Ÿï¼Œè‡ªä¸»ç®¡ç†ç´¢å¼•å’Œæœç´¢
4. **å¯æ‰©å±•**ï¼šæœªæ¥å¯å‡çº§ä¸ºæ··åˆæœç´¢ï¼ˆFTS5 + å‘é‡æ£€ç´¢ï¼‰

---

## ğŸ—ï¸ äºŒã€æ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¤–éƒ¨ MCP Client (Cursor)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ stdio (JSON-RPC)
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   MCP Server (ç‹¬ç«‹è¿›ç¨‹)              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  MCP åè®®å¤„ç†å±‚               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  MCP å·¥å…·å±‚                   â”‚  â”‚
â”‚   â”‚  - search_knowledge_base      â”‚  â”‚
â”‚   â”‚  - get_documents_for_code     â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  KnowledgeBaseDB              â”‚  â”‚
â”‚   â”‚  - SQLite + FTS5              â”‚  â”‚
â”‚   â”‚  - æ–‡æ¡£ç´¢å¼•ç®¡ç†               â”‚  â”‚
â”‚   â”‚  - å…¨æ–‡æœç´¢                   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚                       â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  DocumentIndexer              â”‚  â”‚
â”‚   â”‚  - æ‰«æ .architool ç›®å½•       â”‚  â”‚
â”‚   â”‚  - è§£ææ–‡æ¡£å†…å®¹               â”‚  â”‚
â”‚   â”‚  - åŒæ­¥ç´¢å¼•                   â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ æ–‡ä»¶ç³»ç»Ÿè®¿é—®
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   .architool/ ç›®å½•                   â”‚
â”‚   â”œâ”€â”€ {vault-name}/                 â”‚
â”‚   â”‚   â”œâ”€â”€ *.md                      â”‚
â”‚   â”‚   â”œâ”€â”€ *.archimate               â”‚
â”‚   â”‚   â””â”€â”€ .metadata/                â”‚
â”‚   â””â”€â”€ cache/                        â”‚
â”‚       â””â”€â”€ knowledge.db (SQLite)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®æµ

**æœç´¢æµç¨‹**ï¼š
1. MCP Client å‘é€ `tools/call` è¯·æ±‚ï¼ˆ`search_knowledge_base` æˆ– `get_documents_for_code`ï¼‰
2. MCP Server ç›´æ¥ä½¿ç”¨æœ¬åœ° FTS5 æœç´¢
3. KnowledgeBaseDB æ‰§è¡Œ FTS5 æŸ¥è¯¢
4. è¿”å›æœç´¢ç»“æœï¼ˆåŒ…å«è·¯å¾„ã€ç‰‡æ®µã€å…ƒæ•°æ®ï¼‰

**ç´¢å¼•åŒæ­¥æµç¨‹**ï¼š
1. MCP Server å¯åŠ¨æ—¶æ£€æŸ¥ç´¢å¼•æ˜¯å¦éœ€è¦æ›´æ–°
2. DocumentIndexer æ‰«æ `.architool/` ç›®å½•ï¼ˆç›´æ¥è®¿é—®æ–‡ä»¶ç³»ç»Ÿï¼‰
3. è§£ææ–‡æ¡£å†…å®¹å’Œå…ƒæ•°æ®
4. æ‰¹é‡æ›´æ–° SQLite æ•°æ®åº“

**å…³é”®ç‰¹æ€§**ï¼š
- MCP Server å®Œå…¨ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–ä»»ä½•æ’ä»¶æˆ–å¤–éƒ¨æœåŠ¡
- ç›´æ¥è®¿é—®æ–‡ä»¶ç³»ç»Ÿï¼Œè‡ªä¸»ç®¡ç†ç´¢å¼•
- æ— éœ€ IPC é€šä¿¡ï¼Œå“åº”é€Ÿåº¦æ›´å¿«

---

## ğŸ’¾ ä¸‰ã€æ•°æ®åº“è®¾è®¡

### 3.1 æ•°æ®åº“ä½ç½®

```
~/.architool/cache/knowledge.db
```

**é€‰æ‹©ç†ç”±**ï¼š
- ä½¿ç”¨ç³»ç»Ÿçº§ç¼“å­˜ç›®å½•ï¼ˆè·¨å·¥ä½œåŒºå…±äº«ï¼‰
- ä¾¿äºæ¸…ç†å’Œé‡å»º
- MCP Server ç‹¬ç«‹ç®¡ç†ï¼Œä¸ä¸å…¶ä»–ç»„ä»¶å…±äº«æ•°æ®åº“

### 3.2 è¡¨ç»“æ„

#### 3.2.1 documents è¡¨ï¼ˆä¸»è¡¨ï¼‰

```sql
CREATE TABLE documents (
  id TEXT PRIMARY KEY,                    -- æ–‡æ¡£å”¯ä¸€ IDï¼ˆåŸºäºæ–‡ä»¶è·¯å¾„çš„ hashï¼‰
  path TEXT NOT NULL,                     -- æ–‡æ¡£ç»å¯¹è·¯å¾„ï¼ˆå®Œæ•´æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼‰
  workspace_root TEXT,                    -- å·¥ä½œåŒºæ ¹ç›®å½•ï¼ˆç”¨äºç›¸å¯¹è·¯å¾„è®¡ç®—ï¼‰
  vault_name TEXT,                        -- Vault åç§°
  content TEXT NOT NULL,                  -- æ–‡æ¡£å…¨æ–‡å†…å®¹
  metadata TEXT,                          -- JSON æ ¼å¼çš„å…ƒæ•°æ®
  file_type TEXT,                         -- æ–‡ä»¶ç±»å‹ï¼ˆmd, archimate, etc.ï¼‰
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX documents_path_index ON documents (path);
CREATE INDEX documents_workspace_index ON documents (workspace_root);
CREATE INDEX documents_vault_index ON documents (vault_name);
```

#### 3.2.2 documents_fts è¡¨ï¼ˆFTS5 è™šæ‹Ÿè¡¨ï¼‰

```sql
CREATE VIRTUAL TABLE documents_fts USING fts5(
  content,                                -- å¯æœç´¢çš„å…¨æ–‡å†…å®¹
  path UNINDEXED,                        -- ä¸ç´¢å¼•è·¯å¾„ï¼ˆä»…å­˜å‚¨ï¼‰
  metadata UNINDEXED,                    -- ä¸ç´¢å¼•å…ƒæ•°æ®ï¼ˆä»…å­˜å‚¨ï¼‰
  content='documents',                    -- å…³è”ä¸»è¡¨
  content_rowid='id',                    -- ä½¿ç”¨ id ä½œä¸º rowid
  tokenize='unicode61'                   -- æ”¯æŒä¸­æ–‡åˆ†è¯
);
```

#### 3.2.3 è§¦å‘å™¨ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰

```sql
-- æ’å…¥è§¦å‘å™¨
CREATE TRIGGER documents_fts_insert AFTER INSERT ON documents BEGIN
  INSERT INTO documents_fts(rowid, content)
  VALUES (new.id, new.content);
END;

-- æ›´æ–°è§¦å‘å™¨
CREATE TRIGGER documents_fts_update AFTER UPDATE ON documents BEGIN
  DELETE FROM documents_fts WHERE rowid = old.id;
  INSERT INTO documents_fts(rowid, content)
  VALUES (new.id, new.content);
END;

-- åˆ é™¤è§¦å‘å™¨
CREATE TRIGGER documents_fts_delete AFTER DELETE ON documents BEGIN
  DELETE FROM documents_fts WHERE rowid = old.id;
END;
```

### 3.3 å…ƒæ•°æ®æ ¼å¼

```json
{
  "title": "æ–‡æ¡£æ ‡é¢˜",
  "vaultName": "vault-name",
  "type": "document|design|development|test",
  "category": "åˆ†ç±»",
  "tags": ["tag1", "tag2"],
  "author": "ä½œè€…",
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z"
}
```

---

## ğŸ” å››ã€æœç´¢åŠŸèƒ½è®¾è®¡

### 4.1 FTS5 æœç´¢è¯­æ³•

**åŸºæœ¬æœç´¢**ï¼š
```sql
SELECT path, snippet(documents_fts, '<b>', '</b>', '...', -1, 64) AS snippet
FROM documents_fts
WHERE documents_fts MATCH 'å¾®æœåŠ¡'
ORDER BY rank
LIMIT 20;
```

**é«˜çº§æœç´¢**ï¼š
- `"ç²¾ç¡®çŸ­è¯­"` - çŸ­è¯­åŒ¹é…
- `keyword1 OR keyword2` - OR æŸ¥è¯¢
- `keyword1 AND keyword2` - AND æŸ¥è¯¢
- `keyword1 NOT keyword2` - æ’é™¤æŸ¥è¯¢
- `prefix*` - å‰ç¼€åŒ¹é…

### 4.2 æœç´¢ API è®¾è®¡

```typescript
interface SearchOptions {
  query: string;                    // æœç´¢æŸ¥è¯¢ï¼ˆFTS5 è¯­æ³•ï¼‰
  vaultName?: string;               // å¯é€‰ï¼šè¿‡æ»¤ç‰¹å®š vault
  limit?: number;                   // ç»“æœæ•°é‡é™åˆ¶ï¼ˆé»˜è®¤ 20ï¼‰
  snippetLength?: number;           // ç‰‡æ®µé•¿åº¦ï¼ˆé»˜è®¤ 64ï¼‰
  highlightPrefix?: string;         // é«˜äº®å‰ç¼€ï¼ˆé»˜è®¤ '<b>'ï¼‰
  highlightSuffix?: string;         // é«˜äº®åç¼€ï¼ˆé»˜è®¤ '</b>'ï¼‰
}

interface SearchResult {
  path: string;                     // æ–‡æ¡£ç»å¯¹è·¯å¾„
  relativePath?: string;            // æ–‡æ¡£ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äºå·¥ä½œåŒºæ ¹ç›®å½•ï¼‰
  workspaceRoot?: string;           // å·¥ä½œåŒºæ ¹ç›®å½•
  vaultName?: string;               // Vault åç§°
  title?: string;                   // æ–‡æ¡£æ ‡é¢˜
  snippet: string;                  // é«˜äº®ç‰‡æ®µ
  score?: number;                   // ç›¸å…³æ€§è¯„åˆ†ï¼ˆFTS5 rankï¼‰
  metadata?: any;                   // å…ƒæ•°æ®
}
```

### 4.3 MCP å·¥å…·å®šä¹‰

**search_knowledge_base**ï¼š
```typescript
{
  name: 'search_knowledge_base',
  description: 'Search the architecture knowledge base for design documents, design diagrams, standards, best practices, requirements, and other architecture-related content. Uses SQLite FTS5 for fast local search. Supports Chinese and full-text search with snippet highlighting.',
  inputSchema: {
    type: 'object',
    properties: {
      query: {
        type: 'string',
        description: 'Search query string (supports FTS5 syntax: phrases, AND, OR, NOT, prefix matching)'
      },
      vaultName: {
        type: 'string',
        description: 'Optional: Filter results to a specific vault by name'
      },
      tags: {
        type: 'array',
        items: { type: 'string' },
        description: 'Optional: Filter by tags (AND relationship)'
      },
      limit: {
        type: 'number',
        description: 'Optional: Maximum number of results to return (default: 50)'
      }
    },
    required: ['query']
  }
}
```

**get_documents_for_code**ï¼š
```typescript
{
  name: 'get_documents_for_code',
  description: 'Get architecture documents, design diagrams, standards, best practices, and requirements associated with a specific code file or directory path. Uses local FTS5 search to find related documents.',
  inputSchema: {
    type: 'object',
    properties: {
      codePath: {
        type: 'string',
        description: 'Code file or directory path (relative to workspace root). Supports wildcards like "src/auth/*"'
      }
    },
    required: ['codePath']
  }
}
```

---

## ğŸ“¦ äº”ã€æ–‡æ¡£ç´¢å¼•è®¾è®¡

### 5.1 ç´¢å¼•ç­–ç•¥

**å·¥ä½œåŒºå‘ç°**ï¼š
- é»˜è®¤æ‰«æ `~/.architool/` ç›®å½•ä¸‹çš„æ‰€æœ‰ vault
- æ”¯æŒé€šè¿‡ç¯å¢ƒå˜é‡ `ARCHITOOL_WORKSPACES` æŒ‡å®šé¢å¤–å·¥ä½œåŒºè·¯å¾„ï¼ˆé€—å·åˆ†éš”ï¼‰
- æ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶ `~/.architool/mcp-server-config.json` æŒ‡å®šå·¥ä½œåŒºåˆ—è¡¨
- è‡ªåŠ¨è¯†åˆ«åŒ…å« `.architool/` å­ç›®å½•çš„è·¯å¾„

**å…¨é‡ç´¢å¼•**ï¼š
- MCP Server å¯åŠ¨æ—¶æ‰§è¡Œï¼ˆå¦‚æœæ•°æ®åº“ä¸å­˜åœ¨æˆ–éœ€è¦é‡å»ºï¼‰
- æ‰«ææ‰€æœ‰å‘ç°çš„ `.architool/{vault-name}/` ç›®å½•
- æ’é™¤ `.metadata/` å’Œç³»ç»Ÿç›®å½•
- æ”¯æŒå¤šå·¥ä½œåŒºç»Ÿä¸€ç´¢å¼•

**å¢é‡ç´¢å¼•**ï¼š
- å®šæœŸæ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´ï¼ˆå¯é€‰ï¼‰
- ä»…æ›´æ–°å˜æ›´çš„æ–‡ä»¶
- è‡ªåŠ¨åˆ é™¤å·²ä¸å­˜åœ¨æ–‡ä»¶çš„ç´¢å¼•

**ç´¢å¼•æ–‡ä»¶ç±»å‹**ï¼š
- `.md` - Markdown æ–‡æ¡£
- `.archimate` - ArchiMate æ¶æ„æ–‡ä»¶ï¼ˆæå–æ–‡æœ¬å†…å®¹ï¼‰
- `.yml` / `.yaml` - YAML å…ƒæ•°æ®æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰

### 5.2 æ–‡æ¡£è§£æ

**Markdown æ–‡ä»¶**ï¼š
```typescript
// æå–å†…å®¹
- ç§»é™¤ frontmatterï¼ˆå¦‚æœå­˜åœ¨ï¼‰
- æå–æ­£æ–‡å†…å®¹
- ä¿ç•™æ ‡é¢˜ç»“æ„ï¼ˆç”¨äºä¸Šä¸‹æ–‡ï¼‰
```

**ArchiMate æ–‡ä»¶**ï¼š
```typescript
// æå–å†…å®¹
- è§£æ XML ç»“æ„
- æå–å…ƒç´ åç§°å’Œæè¿°
- æå–å…³ç³»ä¿¡æ¯
```

**å…ƒæ•°æ®æå–**ï¼š
```typescript
// ä» .metadata/{id}.metadata.yml è¯»å–
- æ ‡é¢˜ã€åˆ†ç±»ã€æ ‡ç­¾
- å…³è”å…³ç³»
- ä½œè€…ã€åˆ›å»ºæ—¶é—´ç­‰
```

### 5.3 ç´¢å¼•å™¨å®ç°

```typescript
class DocumentIndexer {
  // æ‰«æ .architool ç›®å½•
  async scanArchitoolDirectory(rootPath: string): Promise<Document[]> {}
  
  // è§£æå•ä¸ªæ–‡æ¡£
  async parseDocument(filePath: string): Promise<KnowledgeDocument> {}
  
  // æ‰¹é‡ç´¢å¼•
  async indexDocuments(docs: KnowledgeDocument[]): Promise<void> {}
  
  // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡å»ºç´¢å¼•
  async needsRebuild(): Promise<boolean> {}
}
```

---

## ğŸ”Œ å…­ã€MCP Server é›†æˆ

### 6.1 å·¥å…·å®ç°ç­–ç•¥

**å®Œå…¨æœ¬åœ°å®ç°**ï¼š

- `search_knowledge_base` â†’ ç›´æ¥ä½¿ç”¨ SQLite FTS5 æœ¬åœ°æœç´¢
- `get_documents_for_code` â†’ åŸºäºä»£ç è·¯å¾„çš„æœ¬åœ° FTS5 æœç´¢

**ä¼˜åŠ¿**ï¼š
- å®Œå…¨ç‹¬ç«‹è¿è¡Œï¼Œä¸ä¾èµ–ä»»ä½•æ’ä»¶æˆ–å¤–éƒ¨æœåŠ¡
- å“åº”é€Ÿåº¦æ›´å¿«ï¼ˆæ— éœ€ IPC é€šä¿¡ï¼Œç›´æ¥è®¿é—®æ•°æ®åº“ï¼‰
- å¯é æ€§æ›´é«˜ï¼ˆæ— å¤–éƒ¨ä¾èµ–ï¼Œå‡å°‘æ•…éšœç‚¹ï¼‰
- å¯éšæ—¶ä½¿ç”¨ï¼ˆæ— éœ€ç­‰å¾…æ’ä»¶å¯åŠ¨ï¼‰

### 6.2 ä»£ç ç»“æ„

```
packages/architool-mcp-server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ mcp-server.ts              # ä¸»å…¥å£
â”‚   â”œâ”€â”€ knowledge-base-db.ts       # SQLite FTS5 æ•°æ®åº“æ¨¡å—
â”‚   â”œâ”€â”€ document-indexer.ts       # æ–‡æ¡£ç´¢å¼•å™¨
â”‚   â””â”€â”€ tools/
â”‚       â”œâ”€â”€ search-tool.ts        # æœç´¢å·¥å…·å®ç°
â”‚       â””â”€â”€ code-documents-tool.ts # ä»£ç å…³è”æ–‡æ¡£å·¥å…·
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

### 6.3 åˆå§‹åŒ–æµç¨‹

```typescript
async function initializeMCPServer() {
  // 1. åˆå§‹åŒ–çŸ¥è¯†åº“æ•°æ®åº“
  const dbPath = path.join(os.homedir(), '.architool', 'cache', 'knowledge.db');
  const db = new KnowledgeBaseDB(dbPath);
  await db.initialize();
  
  // 2. æ£€æŸ¥å¹¶é‡å»ºç´¢å¼•ï¼ˆå¦‚æœéœ€è¦ï¼‰
  const architoolRoot = path.join(os.homedir(), '.architool');
  const indexer = new DocumentIndexer(db, architoolRoot);
  if (await indexer.needsRebuild()) {
    await indexer.rebuildIndex();
  }
  
  // 3. æ³¨å†Œ MCP å·¥å…·
  mcpServer.registerTool('search_knowledge_base', {
    description: '...',
    inputSchema: { ... }
  }, async (params) => {
    return await db.search(params);
  });
  
  mcpServer.registerTool('get_documents_for_code', {
    description: '...',
    inputSchema: { ... }
  }, async (params) => {
    return await db.searchByCodePath(params.codePath);
  });
}
```

---

## ğŸš€ ä¸ƒã€å®ç°æ­¥éª¤

### é˜¶æ®µ 1ï¼šæ ¸å¿ƒæ•°æ®åº“æ¨¡å—ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

1. âœ… åˆ›å»º `KnowledgeBaseDB` ç±»
   - SQLite æ•°æ®åº“åˆå§‹åŒ–
   - FTS5 è™šæ‹Ÿè¡¨åˆ›å»º
   - è§¦å‘å™¨è®¾ç½®
   - åŸºæœ¬ CRUD æ“ä½œ

2. âœ… å®ç°æœç´¢åŠŸèƒ½
   - FTS5 æŸ¥è¯¢
   - snippet é«˜äº®
   - ç»“æœæ ¼å¼åŒ–

### é˜¶æ®µ 2ï¼šæ–‡æ¡£ç´¢å¼•å™¨ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

3. âœ… åˆ›å»º `DocumentIndexer` ç±»
   - æ‰«æ `.architool/` ç›®å½•
   - è§£æ Markdown æ–‡ä»¶
   - è§£æ ArchiMate æ–‡ä»¶
   - è¯»å–å…ƒæ•°æ®æ–‡ä»¶

4. âœ… å®ç°ç´¢å¼•åŒæ­¥
   - å…¨é‡ç´¢å¼•
   - å¢é‡æ›´æ–°
   - ç´¢å¼•é‡å»ºæ£€æµ‹

### é˜¶æ®µ 3ï¼šMCP å·¥å…·é›†æˆï¼ˆä¼˜å…ˆçº§ï¼šä¸­ï¼‰

5. âœ… åˆ›å»ºæœç´¢å·¥å…·
   - å®ç° `search_knowledge_base` å·¥å…·å¤„ç†å‡½æ•°
   - å®ç° `get_documents_for_code` å·¥å…·å¤„ç†å‡½æ•°
   - å‚æ•°éªŒè¯å’Œé”™è¯¯å¤„ç†
   - ç»“æœæ ¼å¼åŒ–ï¼ˆç¬¦åˆ MCP åè®®ï¼‰

6. âœ… é›†æˆåˆ° MCP Server
   - ä½¿ç”¨ `McpServer.registerTool` æ³¨å†Œå·¥å…·
   - åˆå§‹åŒ–æµç¨‹ï¼ˆæ•°æ®åº“ + ç´¢å¼•ï¼‰
   - ç”Ÿå‘½å‘¨æœŸç®¡ç†
   - é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### é˜¶æ®µ 4ï¼šä¼˜åŒ–å’Œæµ‹è¯•ï¼ˆä¼˜å…ˆçº§ï¼šä½ï¼‰

7. â³ æ€§èƒ½ä¼˜åŒ–
   - ç´¢å¼•ç¼“å­˜
   - æŸ¥è¯¢ä¼˜åŒ–
   - æ‰¹é‡æ“ä½œ

8. â³ æµ‹è¯•è¦†ç›–
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•
   - æ€§èƒ½æµ‹è¯•

---

## ğŸ“Š å…«ã€æ€§èƒ½æŒ‡æ ‡

### 8.1 é¢„æœŸæ€§èƒ½

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| æœç´¢å“åº”æ—¶é—´ | < 5ms | å•æ¬¡ FTS5 æŸ¥è¯¢ |
| ç´¢å¼•é€Ÿåº¦ | > 100 docs/s | æ‰¹é‡ç´¢å¼• |
| æ•°æ®åº“å¤§å° | < 100MB | 10,000 æ–‡æ¡£ |
| å†…å­˜å ç”¨ | < 50MB | MCP Server è¿›ç¨‹ |

### 8.2 ä¼˜åŒ–ç­–ç•¥

1. **WAL æ¨¡å¼**ï¼šå¯ç”¨ SQLite WAL æ¨¡å¼æé«˜å¹¶å‘æ€§èƒ½
2. **æ‰¹é‡æ’å…¥**ï¼šä½¿ç”¨äº‹åŠ¡æ‰¹é‡æ’å…¥æ–‡æ¡£
3. **ç´¢å¼•ç¼“å­˜**ï¼šç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœï¼ˆå¯é€‰ï¼‰
4. **å¢é‡æ›´æ–°**ï¼šä»…æ›´æ–°å˜æ›´çš„æ–‡ä»¶

---

## ğŸ”® ä¹ã€æœªæ¥æ‰©å±•

### 9.1 æ··åˆæœç´¢ï¼ˆFTS5 + å‘é‡æ£€ç´¢ï¼‰

**æ¶æ„**ï¼š
```
æœç´¢è¯·æ±‚
  â”œâ”€â†’ FTS5 æœç´¢ï¼ˆå…³é”®è¯åŒ¹é…ï¼‰
  â””â”€â†’ å‘é‡æœç´¢ï¼ˆè¯­ä¹‰ç›¸ä¼¼åº¦ï¼‰
       â””â”€â†’ ç»“æœèåˆï¼ˆåŠ æƒæ’åºï¼‰
```

**å®ç°**ï¼š
- ä½¿ç”¨ BGE-M3 æˆ–ç±»ä¼¼æ¨¡å‹ç”Ÿæˆå‘é‡
- ä½¿ç”¨ FAISS æˆ– SQLite å‘é‡æ‰©å±•å­˜å‚¨å‘é‡
- èåˆ FTS5 å’Œå‘é‡æœç´¢ç»“æœ

### 9.2 é«˜çº§åŠŸèƒ½

1. **è¯­ä¹‰æœç´¢**ï¼šåŸºäºå‘é‡ç›¸ä¼¼åº¦çš„è¯­ä¹‰æœç´¢
2. **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ”¯æŒè‹±æ–‡ã€ä¸­æ–‡ç­‰å¤šç§è¯­è¨€
3. **å®æ—¶ç´¢å¼•**ï¼šç›‘å¬æ–‡ä»¶ç³»ç»Ÿå˜åŒ–ï¼Œå®æ—¶æ›´æ–°ç´¢å¼•
4. **æœç´¢å†å²**ï¼šè®°å½•æœç´¢å†å²ï¼Œæä¾›æœç´¢å»ºè®®

---

## ğŸ“ åã€æŠ€æœ¯é€‰å‹

### 10.1 ä¾èµ–åŒ…

```json
{
  "dependencies": {
    "@modelcontextprotocol/sdk": "^1.24.3",  // MCP SDKï¼ˆå·²æœ‰ï¼‰
    "better-sqlite3": "^9.0.0"                // SQLite é©±åŠ¨ï¼ˆæ–°å¢ï¼‰
  },
  "devDependencies": {
    "@types/better-sqlite3": "^7.6.0",       // TypeScript ç±»å‹ï¼ˆæ–°å¢ï¼‰
    "@types/node": "^20.0.0",                 // Node.js ç±»å‹ï¼ˆå·²æœ‰ï¼‰
    "typescript": "^5.0.0"                    // TypeScriptï¼ˆå·²æœ‰ï¼‰
  }
}
```

### 10.2 ä¸ºä»€ä¹ˆé€‰æ‹© better-sqlite3ï¼Ÿ

- âœ… **åŒæ­¥ API**ï¼šç®€åŒ–ä»£ç ï¼Œæ— éœ€ async/await
- âœ… **é«˜æ€§èƒ½**ï¼šæ¯” sqlite3 å¿« 2-3 å€
- âœ… **TypeScript æ”¯æŒ**ï¼šå®Œæ•´çš„ç±»å‹å®šä¹‰
- âœ… **æ´»è·ƒç»´æŠ¤**ï¼šç¤¾åŒºæ´»è·ƒï¼Œæ›´æ–°åŠæ—¶

---

## âš ï¸ åä¸€ã€æ³¨æ„äº‹é¡¹

### 11.1 ç´¢å¼•åŒæ­¥ç­–ç•¥

**å…¨é‡ç´¢å¼•**ï¼š
- MCP Server å¯åŠ¨æ—¶æ£€æŸ¥ç´¢å¼•æ˜¯å¦éœ€è¦é‡å»º
- æ‰«æ `~/.architool/` ç›®å½•ä¸‹çš„æ‰€æœ‰ vault
- è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶å˜æ›´ï¼ˆåŸºäºä¿®æ”¹æ—¶é—´ï¼‰

**å¢é‡æ›´æ–°**ï¼š
- å®šæœŸæ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´ï¼ˆå¯é€‰ï¼‰
- ä»…æ›´æ–°å˜æ›´çš„æ–‡ä»¶
- åˆ é™¤å·²ä¸å­˜åœ¨çš„æ–‡ä»¶ç´¢å¼•

**ç´¢å¼•é‡å»ºè§¦å‘æ¡ä»¶**ï¼š
1. æ•°æ®åº“ä¸å­˜åœ¨
2. æ•°æ®åº“ç‰ˆæœ¬ä¸åŒ¹é…
3. ç´¢å¼•æ—¶é—´æˆ³è¿‡æœŸï¼ˆè¶…è¿‡é…ç½®çš„é˜ˆå€¼ï¼‰

### 11.2 å·¥ä½œåŒºå‘ç°å’Œç´¢å¼•

**å·¥ä½œåŒºå‘ç°ç­–ç•¥**ï¼š
1. **ä¸»ç›®å½•æ‰«æ**ï¼šæ‰«æ `~/.architool/` ä¸‹çš„æ‰€æœ‰ vault ç›®å½•
2. **ç¯å¢ƒå˜é‡**ï¼šæ”¯æŒ `ARCHITOOL_WORKSPACES` ç¯å¢ƒå˜é‡æŒ‡å®šé¢å¤–å·¥ä½œåŒºè·¯å¾„
3. **é…ç½®æ–‡ä»¶**ï¼šå¯é€‰é…ç½®æ–‡ä»¶ `~/.architool/mcp-server-config.json` æŒ‡å®šå·¥ä½œåŒºåˆ—è¡¨

**å¤šå·¥ä½œåŒºæ”¯æŒ**ï¼š
- MCP Server æ˜¯å…¨å±€è¿›ç¨‹ï¼Œç´¢å¼•æ‰€æœ‰å‘ç°çš„ `.architool/` ç›®å½•
- ç»Ÿä¸€ç´¢å¼•åˆ° `~/.architool/cache/knowledge.db`
- åœ¨æœç´¢ç»“æœä¸­æ ‡è¯† vault åç§°å’Œå·¥ä½œåŒºè·¯å¾„
- æ”¯æŒæŒ‰ vault åç§°è¿‡æ»¤

**è·¯å¾„å¤„ç†**ï¼š
- å­˜å‚¨å®Œæ•´è·¯å¾„ï¼ˆåŒ…å«å·¥ä½œåŒºæ ¹ç›®å½•ï¼‰
- åœ¨æœç´¢ç»“æœä¸­è¿”å›ç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„
- ä½¿ç”¨ `path.posix` æ ‡å‡†åŒ–è·¯å¾„ï¼ˆè·¨å¹³å°å…¼å®¹ï¼‰
- æ”¯æŒè·¨å·¥ä½œåŒºæœç´¢

### 11.3 æ–‡ä»¶è·¯å¾„å¤„ç†

**é—®é¢˜**ï¼šä¸åŒæ“ä½œç³»ç»Ÿçš„è·¯å¾„æ ¼å¼ä¸åŒï¼Œéœ€è¦è·¨å¹³å°æ”¯æŒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. å­˜å‚¨æ—¶ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼ˆä¾¿äºè·¨å·¥ä½œåŒºæœç´¢ï¼‰
2. ä½¿ç”¨ `path.posix` æ ‡å‡†åŒ–è·¯å¾„ï¼ˆç»Ÿä¸€ä½¿ç”¨ `/` åˆ†éš”ç¬¦ï¼‰
3. åœ¨æœç´¢ç»“æœä¸­è¿”å›æ ‡å‡†åŒ–è·¯å¾„ï¼ˆç›¸å¯¹è·¯å¾„å’Œç»å¯¹è·¯å¾„ï¼‰
4. æ”¯æŒè·¯å¾„é€šé…ç¬¦åŒ¹é…ï¼ˆç”¨äº `get_documents_for_code`ï¼‰

### 11.3 æ–‡ä»¶è·¯å¾„å¤„ç†

**é—®é¢˜**ï¼šä¸åŒæ“ä½œç³»ç»Ÿçš„è·¯å¾„æ ¼å¼ä¸åŒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç»Ÿä¸€ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆç›¸å¯¹äºå·¥ä½œåŒºæ ¹ç›®å½•ï¼‰
2. ä½¿ç”¨ `path.posix` æ ‡å‡†åŒ–è·¯å¾„
3. åœ¨æœç´¢ç»“æœä¸­è¿”å›æ ‡å‡†åŒ–è·¯å¾„

---

## âœ… åäºŒã€éªŒæ”¶æ ‡å‡†

### 12.1 åŠŸèƒ½éªŒæ”¶

- [ ] èƒ½å¤Ÿç´¢å¼• `.architool/` ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡æ¡£
- [ ] æ”¯æŒä¸­æ–‡å…¨æ–‡æœç´¢
- [ ] è¿”å›æ–‡æ¡£è·¯å¾„å’Œé«˜äº®ç‰‡æ®µ
- [ ] æœç´¢å“åº”æ—¶é—´ < 5ms
- [ ] æ”¯æŒ FTS5 é«˜çº§è¯­æ³•ï¼ˆANDã€ORã€NOTã€çŸ­è¯­ï¼‰

### 12.2 é›†æˆéªŒæ”¶

- [ ] MCP Client èƒ½å¤Ÿè°ƒç”¨ `search_knowledge_base_fts5` å·¥å…·
- [ ] æœç´¢ç»“æœæ ¼å¼ç¬¦åˆ MCP åè®®è§„èŒƒ
- [ ] é”™è¯¯å¤„ç†å®Œå–„ï¼Œä¸ä¼šå¯¼è‡´ MCP Server å´©æºƒ

### 12.3 æ€§èƒ½éªŒæ”¶

- [ ] 10,000 æ–‡æ¡£ç´¢å¼•æ—¶é—´ < 2 åˆ†é’Ÿ
- [ ] å•æ¬¡æœç´¢å“åº”æ—¶é—´ < 5ms
- [ ] æ•°æ®åº“æ–‡ä»¶å¤§å°åˆç†ï¼ˆ< 100MB for 10K docsï¼‰

---

## ğŸ“š åä¸‰ã€å‚è€ƒèµ„æ–™

- [SQLite FTS5 æ–‡æ¡£](https://www.sqlite.org/fts5.html)
- [better-sqlite3 æ–‡æ¡£](https://github.com/WiseLibs/better-sqlite3)
- [MCP åè®®è§„èŒƒ](https://modelcontextprotocol.io/)
- [FTS5 æŸ¥è¯¢è¯­æ³•](https://www.sqlite.org/fts5.html#fts5_query_syntax)

---

## ğŸ¯ æ€»ç»“

æœ¬æ–¹æ¡ˆæä¾›äº†ä¸€ä¸ª**è½»é‡çº§ã€é«˜æ€§èƒ½ã€å®Œå…¨ç‹¬ç«‹**çš„æœ¬åœ°çŸ¥è¯†åº“æœç´¢è§£å†³æ–¹æ¡ˆï¼š

1. **å®Œå…¨ç‹¬ç«‹æ€§**ï¼šMCP Server æ˜¯å®Œå…¨ç‹¬ç«‹çš„è¿›ç¨‹ï¼Œä¸ä¾èµ– VS Code æ‰©å±•ã€æ’ä»¶æˆ–ä»»ä½•å¤–éƒ¨æœåŠ¡
2. **é«˜æ€§èƒ½**ï¼šä½¿ç”¨ FTS5 å®ç°æ¯«ç§’çº§æœç´¢å“åº”ï¼Œç›´æ¥è®¿é—®æœ¬åœ°æ•°æ®åº“
3. **è‡ªåŒ…å«**ï¼šç›´æ¥è®¿é—®æ–‡ä»¶ç³»ç»Ÿï¼Œè‡ªä¸»ç®¡ç†ç´¢å¼•å’Œæœç´¢ï¼Œæ— éœ€ IPC é€šä¿¡
4. **å¯æ‰©å±•æ€§**ï¼šæœªæ¥å¯å‡çº§ä¸ºæ··åˆæœç´¢ï¼ˆFTS5 + å‘é‡æ£€ç´¢ï¼‰

**æ ¸å¿ƒä¼˜åŠ¿**ï¼š
- âœ… æ— éœ€ç­‰å¾…æ’ä»¶å¯åŠ¨ï¼Œéšæ—¶å¯ç”¨
- âœ… å“åº”é€Ÿåº¦å¿«ï¼ˆæ—  IPC é€šä¿¡å¼€é”€ï¼‰
- âœ… å¯é æ€§é«˜ï¼ˆæ— å¤–éƒ¨ä¾èµ–ï¼‰
- âœ… æ˜“äºéƒ¨ç½²ï¼ˆå•ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼‰

**ä¸‹ä¸€æ­¥**ï¼šæŒ‰ç…§å®ç°æ­¥éª¤ï¼Œä»é˜¶æ®µ 1 å¼€å§‹é€æ­¥å®ç°ã€‚

